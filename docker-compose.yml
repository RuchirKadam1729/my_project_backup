services:
  mongodb:
    image: mongo:7
    volumes:
      - mongodb_data:/data/db
    restart: unless-stopped

  backend:
    image: python:3.11
    volumes:
      - ./backend:/data
    working_dir: /data
    command: sh -c "pip install -r requirements.txt && uvicorn server:app --host 0.0.0.0 --port 80 --reload"
    environment:
      - MONGODB_URL=mongodb://mongodb:27017/judiciary_db
    depends_on:
      - mongodb
    restart: unless-stopped

  frontend:
    image: node:24-alpine
    volumes:
      - ./frontend:/data
    working_dir: /data
    command: sh -c "yarn install && yarn start"
    environment:
      - WATCHPACK_POLLING=true
      - WDS_SOCKET_PORT=0
    depends_on:
      - backend
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - frontend
      - backend
    restart: unless-stopped

  tunnel-frontend:
    image: cloudflare/cloudflared:latest
    command: tunnel --url http://nginx:80 --no-autoupdate
    depends_on:
      - nginx
    restart: unless-stopped

volumes:
  mongodb_data: